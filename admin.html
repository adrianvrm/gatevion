<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gatevion – Admin Dashboard</title>
  <meta name="theme-color" content="#02ac8e" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#02ac8e' }
        }
      }
    }
  <script>
(function () {
  const API_BASE = (window.GATEVION_API_BASE || 'http://localhost:4000');
  const tokenKey = 'gatevion_token';
  const userKey = 'gatevion_user';

  const loginShell = document.getElementById('loginShell');
  const adminShell = document.getElementById('adminShell');
  const whoEl = document.getElementById('whoami');
  const loginForm = document.getElementById('adminLoginForm');
  const loginError = document.getElementById('adminLoginError');

  const panes = {
    overview: document.getElementById('tab-overview'),
    reservations: document.getElementById('tab-overview'), // același pane pentru Overview/Rezervări
    partners: document.getElementById('tab-partners'),
    cars: document.getElementById('tab-cars'),
    rules: document.getElementById('tab-rules'),
    airports: document.getElementById('tab-airports'),
    account: document.getElementById('tab-account')
  };

  const navButtons = Array.prototype.slice.call(document.querySelectorAll('[data-tab]'));
  let currentTab = 'overview';

  function setView(view) {
    if (view === 'admin') {
      if (loginShell) loginShell.classList.add('hidden');
      if (adminShell) adminShell.classList.remove('hidden');
    } else {
      if (adminShell) adminShell.classList.add('hidden');
      if (loginShell) loginShell.classList.remove('hidden');
    }
  }

  async function api(path, options) {
    options = options || {};
    const token = localStorage.getItem(tokenKey);
    const headers = options.headers ? Object.assign({}, options.headers) : {};

    // Nu impunem Content-Type dacă trimitem FormData
    if (!headers['Content-Type'] && !(options.body instanceof FormData)) {
      headers['Content-Type'] = 'application/json';
    }
    if (token) {
      headers['Authorization'] = 'Bearer ' + token;
    }

    const res = await fetch(API_BASE + path, Object.assign({}, options, { headers: headers }));
    let data = {};
    try {
      data = await res.json();
    } catch (e) {
      data = {};
    }

    if (res.status === 401) {
      localStorage.removeItem(tokenKey);
      localStorage.removeItem(userKey);
      setView('login');
      throw new Error(data.error || 'Neautorizat');
    }
    if (!res.ok) {
      throw new Error(data.error || res.statusText || 'Eroare API');
    }
    return data;
  }

  function activate(tab) {
    currentTab = tab;

    // butoane de navigare
    navButtons.forEach(function (btn) {
      const name = btn.getAttribute('data-tab');
      if (!name) return;
      if (name === tab) {
        btn.classList.add('bg-slate-900', 'text-white');
        btn.classList.remove('text-slate-600');
      } else {
        btn.classList.remove('bg-slate-900', 'text-white');
        btn.classList.add('text-slate-600');
      }
    });

    // panouri
    Object.keys(panes).forEach(function (name) {
      const pane = panes[name];
      if (!pane) return;
      if (name === tab || (name === 'overview' && tab === 'reservations')) {
        pane.classList.remove('hidden');
      } else {
        pane.classList.add('hidden');
      }
    });

    if (tab === 'overview' || tab === 'reservations') {
      loadOverviewStats();
      loadReservations();
    }
  }

  async function loadOverviewStats() {
    try {
      const data = await api('/api/reservations/stats/overview');
      const totals = data.totals || {};
      const byAirport = data.byAirport || [];

      function setText(id, val) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      }

      setText('statTotal', totals.total || 0);
      setText('statPending', totals.pending || 0);
      setText('statConfirmed', totals.confirmed || 0);
      setText('statCancelled', totals.cancelled || 0);

      const tbody = document.getElementById('airportStatsRows');
      if (tbody) {
        tbody.innerHTML = '';
        byAirport.forEach(function (row) {
          const tr = document.createElement('tr');
          const name = (row.code || '-') + (row.name ? (' – ' + row.name) : '');
          tr.innerHTML = [
            '<td class="py-2 pr-4">', name, '</td>',
            '<td class="py-2 pr-4">', row.total || 0, '</td>',
            '<td class="py-2 pr-4">', row.pending || 0, '</td>',
            '<td class="py-2 pr-4">', row.confirmed || 0, '</td>',
            '<td class="py-2 pr-4">', row.cancelled || 0, '</td>'
          ].join('');
          tbody.appendChild(tr);
        });
      }
    } catch (err) {
      console.error('Eroare la încărcarea statisticilor overview', err);
    }
  }

  async function loadReservations() {
    try {
      const tbody = document.getElementById('resRows');
      if (!tbody) return;
      tbody.innerHTML = '';

      const list = await api('/api/reservations');
      list.forEach(function (r) {
        const tr = document.createElement('tr');
        const pickupText =
          (r.pickup_at ? new Date(r.pickup_at).toLocaleString() : '-') +
          (r.pickup_code ? ' (' + r.pickup_code + ')' : '');
        const dropoffText =
          (r.dropoff_at ? new Date(r.dropoff_at).toLocaleString() : '-') +
          (r.dropoff_code ? ' (' + r.dropoff_code + ')' : '');
        const totalText =
          r.total_price != null ? (Number(r.total_price).toFixed(2) + ' €') : '-';
        const statusClass =
          r.status === 'confirmed'
            ? 'bg-emerald-100 text-emerald-800'
            : r.status === 'pending'
            ? 'bg-amber-100 text-amber-800'
            : r.status === 'cancelled'
            ? 'bg-rose-100 text-rose-800'
            : 'bg-slate-200 text-slate-700';

        tr.innerHTML = [
          '<td class="py-2 pr-4">', r.id, '</td>',
          '<td class="py-2 pr-4">', (r.customer_name || r.user_email || '-'), '</td>',
          '<td class="py-2 pr-4">', (r.car_name || '-'), '</td>',
          '<td class="py-2 pr-4">', pickupText, '</td>',
          '<td class="py-2 pr-4">', dropoffText, '</td>',
          '<td class="py-2 pr-4">', totalText, '</td>',
          '<td class="py-2 pr-4"><span class="badge ', statusClass, '">', r.status, '</span></td>',
          '<td class="py-2 pr-4">',
            '<button class="px-2 py-1 rounded border" data-action="view" data-id="', r.id, '">Vezi detalii</button>',
          '</td>'
        ].join('');
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error('Eroare la încărcarea rezervărilor', err);
    }
  }

  async function openReservationDetails(id) {
    const modal = document.getElementById('reservationModal');
    const body = document.getElementById('reservationModalBody');
    const closeBtn = document.getElementById('reservationModalClose');
    if (!modal || !body) return;

    modal.classList.remove('hidden');
    body.innerHTML = '<div class="text-center text-slate-500">Se încarcă...</div>';

    try {
      const results = await Promise.all([
        api('/api/reservations/' + id),
        api('/api/reservations/' + id + '/documents'),
        api('/api/partners')
      ]);
      const reservation = results[0];
      const docs = results[1] || [];
      const partners = results[2] || [];

      const pickupInfo =
        (reservation.pickup_at ? new Date(reservation.pickup_at).toLocaleString() : '-') +
        (reservation.pickup_name ? ' – ' + reservation.pickup_name : '') +
        (reservation.pickup_code ? ' (' + reservation.pickup_code + ')' : '');

      const dropoffInfo =
        (reservation.dropoff_at ? new Date(reservation.dropoff_at).toLocaleString() : '-') +
        (reservation.dropoff_name ? ' – ' + reservation.dropoff_name : '') +
        (reservation.dropoff_code ? ' (' + reservation.dropoff_code + ')' : '');

      const docsHtml = docs.length
        ? '<ul class="list-disc pl-5 space-y-1">' +
            docs.map(function (d) {
              const label = d.doc_type || d.file_name;
              const href = '/uploads/' + d.file_path;
              return '<li><a href="' + href + '" target="_blank" class="text-primary underline">' +
                     label + '</a></li>';
            }).join('') +
          '</ul>'
        : '<div class="text-slate-500 text-sm">Nu există documente atașate.</div>';

      const partnersOptions = partners.map(function (p) {
        return '<option value="' + p.id + '">' + p.name + '</option>';
      }).join('');

      body.innerHTML =
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
          '<div class="space-y-1">' +
            '<div class="text-xs font-semibold text-slate-500">ID rezervare</div>' +
            '<div class="font-mono text-sm">' + reservation.id + '</div>' +

            '<div class="text-xs font-semibold text-slate-500 mt-3">Client</div>' +
            '<div>' + (reservation.customer_name || '-') + '</div>' +
            '<div class="text-slate-500">' + (reservation.customer_email || '') + '</div>' +
            '<div class="text-slate-500">' + (reservation.customer_phone || '') + '</div>' +

            '<div class="text-xs font-semibold text-slate-500 mt-3">Număr zbor</div>' +
            '<div>' + (reservation.flight_number || '-') + '</div>' +

            '<div class="text-xs font-semibold text-slate-500 mt-3">Status</div>' +
            '<div>' + reservation.status + '</div>' +
          '</div>' +
          '<div class="space-y-2">' +
            '<div>' +
              '<div class="text-xs font-semibold text-slate-500">Mașină</div>' +
              '<div>' + (reservation.car_name || '-') + '</div>' +
            '</div>' +
            '<div>' +
              '<div class="text-xs font-semibold text-slate-500">Preluare</div>' +
              '<div>' + pickupInfo + '</div>' +
            '</div>' +
            '<div>' +
              '<div class="text-xs font-semibold text-slate-500">Returnare</div>' +
              '<div>' + dropoffInfo + '</div>' +
            '</div>' +
            '<div>' +
              '<div class="text-xs font-semibold text-slate-500">Total</div>' +
              '<div>' +
                (reservation.total_price != null
                  ? (Number(reservation.total_price).toFixed(2) + ' €')
                  : '-') +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +

        '<div class="mt-4">' +
          '<div class="text-xs font-semibold text-slate-500 mb-1">Documente client</div>' +
          docsHtml +
        '</div>' +

        '<div class="mt-4 border-t pt-4 space-y-3">' +
          '<div class="flex flex-wrap gap-2">' +
            '<button id="btnEditReservation" class="px-3 py-1.5 rounded-lg border text-sm">Modifică rezervarea</button>' +
            '<button id="btnExtendReservation" class="px-3 py-1.5 rounded-lg border text-sm">Prelungește returul</button>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
            '<select id="partnerSelect" class="border rounded-lg px-2 py-1 text-sm">' +
              '<option value="">Alege partener...</option>' +
              partnersOptions +
            '</select>' +
            '<button id="btnAssignPartner" class="px-3 py-1.5 rounded-lg border text-sm">Alocă partener</button>' +
          '</div>' +
        '</div>';

      const editBtn = document.getElementById('btnEditReservation');
      if (editBtn) {
        editBtn.onclick = function () {
          const newName = window.prompt('Nume client', reservation.customer_name || '');
          const newEmail = window.prompt('Email', reservation.customer_email || '');
          const newPhone = window.prompt('Telefon', reservation.customer_phone || '');
          const newFlight = window.prompt('Număr zbor', reservation.flight_number || '');
          const newPickupAt = window.prompt('Pickup (ISO datetime)', reservation.pickup_at || '');
          const newDropoffAt = window.prompt('Dropoff (ISO datetime)', reservation.dropoff_at || '');
          const newStatus = window.prompt('Status (pending/confirmed/cancelled)', reservation.status || 'pending');

          api('/api/reservations/' + id, {
            method: 'PATCH',
            body: JSON.stringify({
              customerName: newName,
              customerEmail: newEmail,
              customerPhone: newPhone,
              flightNumber: newFlight,
              pickupAt: newPickupAt,
              dropoffAt: newDropoffAt,
              status: newStatus
            })
          }).then(function () {
            return loadReservations();
          }).then(function () {
            return openReservationDetails(id);
          }).catch(function (err) {
            window.alert('Eroare: ' + err.message);
          });
        };
      }

      const extendBtn = document.getElementById('btnExtendReservation');
      if (extendBtn) {
        extendBtn.onclick = function () {
          const newDropoffAt = window.prompt(
            'Noua dată/ora de retur (ISO datetime)',
            reservation.dropoff_at || ''
          );
          const newDropAirportIdStr = window.prompt(
            'ID nou aeroport retur (gol pentru a păstra actualul)',
            reservation.airport_dropoff_id || ''
          );
          const payload = { dropoffAt: newDropoffAt };
          if (newDropAirportIdStr) {
            payload.airportDropoffId = Number(newDropAirportIdStr);
          }

          api('/api/reservations/' + id, {
            method: 'PATCH',
            body: JSON.stringify(payload)
          }).then(function () {
            return loadReservations();
          }).then(function () {
            return openReservationDetails(id);
          }).catch(function (err) {
            window.alert('Eroare: ' + err.message);
          });
        };
      }

      const assignBtn = document.getElementById('btnAssignPartner');
      const partnerSelect = document.getElementById('partnerSelect');
      if (assignBtn && partnerSelect) {
        assignBtn.onclick = function () {
          const pidStr = partnerSelect.value;
          if (!pidStr) {
            window.alert('Te rugăm să alegi un partener.');
            return;
          }
          const pid = Number(pidStr);
          api('/api/partners/' + pid + '/send-reservation', {
            method: 'POST',
            body: JSON.stringify({ reservationId: id })
          }).then(function () {
            window.alert('Rezervarea a fost trimisă partenerului selectat.');
          }).catch(function (err) {
            window.alert('Eroare: ' + err.message);
          });
        };
      }

    } catch (err) {
      console.error('Eroare la încărcarea detaliilor rezervării', err);
      body.innerHTML = '<div class="text-red-600 text-sm">Eroare la încărcarea detaliilor rezervării.</div>';
    }

    if (closeBtn) {
      closeBtn.onclick = function () {
        modal.classList.add('hidden');
      };
    }
    modal.addEventListener('click', function (e) {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  }

  async function initAdmin() {
    // hook butoane tab-uri
    navButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const tab = btn.getAttribute('data-tab');
        if (tab) {
          activate(tab);
        }
      });
    });

    // click pe rânduri Rezervări (Vezi detalii)
    const resRows = document.getElementById('resRows');
    if (resRows) {
      resRows.addEventListener('click', function (e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if (action === 'view' && id) {
          openReservationDetails(id).catch(function (err) {
            window.alert('Eroare: ' + err.message);
          });
        }
      });
    }

    const storedUser = localStorage.getItem(userKey);
    if (storedUser && whoEl) {
      try {
        const u = JSON.parse(storedUser);
        whoEl.textContent = u.email || '';
      } catch (e) {
        // ignoră
      }
    }

    activate('overview');
  }

  // Login admin
  if (loginForm) {
    loginForm.addEventListener('submit', function (e) {
      e.preventDefault();
      if (loginError) {
        loginError.classList.add('hidden');
        loginError.textContent = '';
      }
      const emailInput = document.getElementById('adminUser');
      const passwordInput = document.getElementById('adminPassword');
      const email = emailInput ? (emailInput.value || '').trim() : '';
      const password = passwordInput ? (passwordInput.value || '').trim() : '';

      if (!email || !password) {
        if (loginError) {
          loginError.textContent = 'Completează user și parolă.';
          loginError.classList.remove('hidden');
        }
        return;
      }

      api('/api/auth/login', {
        method: 'POST',
        body: JSON.stringify({ email: email, password: password })
      }).then(function (data) {
        if (!data.user || data.user.role !== 'admin') {
          throw new Error('Acest utilizator nu are rol de admin.');
        }
        localStorage.setItem(tokenKey, data.token);
        localStorage.setItem(userKey, JSON.stringify(data.user || {}));
        setView('admin');
        return initAdmin();
      }).catch(function (err) {
        if (loginError) {
          loginError.textContent = 'Autentificare eșuată: ' + err.message;
          loginError.classList.remove('hidden');
        }
      });
    });
  }

  // Auto-login dacă avem deja token
  (function autoStart() {
    const storedToken = localStorage.getItem(tokenKey);
    const storedUser = localStorage.getItem(userKey);
    if (storedToken && storedUser) {
      setView('admin');
      initAdmin().catch(function (err) {
        console.error(err);
        setView('login');
      });
    } else {
      setView('login');
    }
  })();
})();
</script>

</body>
</html>
